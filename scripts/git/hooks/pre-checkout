#!/bin/bash
# Pre-checkout hook: Validates branch naming convention for work items

# Get the branch name being created
BRANCH_NAME="$2"

# Skip if switching to existing branch or main
if [ "$3" = "0" ] || [ "$BRANCH_NAME" = "main" ]; then
    exit 0
fi

# Define valid patterns
VS_PATTERN="^feat/vs-[0-9]{3}-"
BR_PATTERN="^fix/br-[0-9]{3}-"
TD_PATTERN="^feat/td-[0-9]{3}-"
OTHER_PATTERNS="^(feat|fix|docs|chore|test|perf|refactor)/"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if it matches work item patterns
if echo "$BRANCH_NAME" | grep -qE "^(feat/vs-|fix/br-|feat/td-)"; then
    # It's trying to be a work item branch - validate format
    if echo "$BRANCH_NAME" | grep -qE "$VS_PATTERN|$BR_PATTERN|$TD_PATTERN"; then
        echo -e "${GREEN}‚úÖ Valid work item branch: $BRANCH_NAME${NC}"
        
        # Extract item info
        if echo "$BRANCH_NAME" | grep -qE "$VS_PATTERN"; then
            ITEM=$(echo "$BRANCH_NAME" | sed -E 's/feat\/vs-([0-9]{3}).*/VS_\1/')
        elif echo "$BRANCH_NAME" | grep -qE "$BR_PATTERN"; then
            ITEM=$(echo "$BRANCH_NAME" | sed -E 's/fix\/br-([0-9]{3}).*/BR_\1/')
        elif echo "$BRANCH_NAME" | grep -qE "$TD_PATTERN"; then
            ITEM=$(echo "$BRANCH_NAME" | sed -E 's/feat\/td-([0-9]{3}).*/TD_\1/')
        fi
        
        echo -e "${YELLOW}üìã Working on: $ITEM${NC}"
        echo -e "${YELLOW}Remember to check Docs/01-Active/Backlog.md for item details${NC}"
    else
        echo -e "${RED}‚ùå Invalid work item branch format: $BRANCH_NAME${NC}"
        echo ""
        echo "Work item branches must follow these patterns:"
        echo "  feat/vs-XXX-description  (for VS items)"
        echo "  fix/br-XXX-description   (for BR items)"
        echo "  feat/td-XXX-description  (for TD items)"
        echo ""
        echo "Examples:"
        echo "  feat/vs-003-match-system"
        echo "  fix/br-006-parallel-work"
        echo "  feat/td-009-persona-commands"
        echo ""
        exit 1
    fi
elif echo "$BRANCH_NAME" | grep -qE "$OTHER_PATTERNS"; then
    # Non-work-item branch - allowed
    echo -e "${GREEN}‚úÖ Valid branch: $BRANCH_NAME${NC}"
else
    echo -e "${RED}‚ùå Invalid branch name: $BRANCH_NAME${NC}"
    echo ""
    echo "Branch names must start with one of:"
    echo "  feat/  fix/  docs/  chore/  test/  perf/  refactor/"
    echo ""
    echo "For work items, use:"
    echo "  feat/vs-XXX-description  (VS items)"
    echo "  fix/br-XXX-description   (BR items)"
    echo "  feat/td-XXX-description  (TD items)"
    echo ""
    exit 1
fi

exit 0